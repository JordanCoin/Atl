{
  "id": "amazon-price-watch-airpods",
  "name": "AirPods Pro Price Monitor",
  "version": "2.0",
  "description": "Resilient price monitoring with selector fallbacks",
  "schedule": "0 */4 * * *",
  "profile": "amazon-default",
  "resilience": {
    "retryCount": 2,
    "retryStrategies": ["scroll", "wait", "reload"],
    "captureOnFailure": true,
    "degradedIsSuccess": true
  },
  "alertThreshold": {
    "priceBelow": 200
  },
  "steps": [
    {
      "id": "load-product",
      "action": "goto",
      "params": { "url": "https://www.amazon.com/dp/B0D1XD1ZV3" },
      "timeout": 15000,
      "required": true
    },
    {
      "id": "wait-ready",
      "action": "waitForAny",
      "selectors": [
        "#productTitle",
        "#title",
        "#btfContent",
        "h1[itemprop='name']",
        ".product-title-word-break",
        "h1"
      ],
      "timeout": 10000,
      "required": true
    },
    {
      "id": "extract-title",
      "action": "extract",
      "selector": {
        "chain": [
          "#productTitle",
          "#title",
          "#btfContent h1",
          "h1[itemprop='name']",
          ".product-title-word-break",
          "h1"
        ],
        "fallbackScript": "document.title.split(':')[0].split('-')[0].trim()",
        "transform": "text.split('\\n')[0].trim().substring(0, 200)"
      },
      "saveAs": "productTitle",
      "validate": {
        "type": "string",
        "minLength": 5,
        "notContains": ["Page Not Found", "Error", "Robot Check"]
      },
      "required": true
    },
    {
      "id": "extract-price",
      "action": "extract",
      "selector": {
        "chain": [
          ".a-price .a-offscreen",
          "#priceblock_ourprice",
          "#corePrice_feature_div .a-offscreen",
          "[data-a-color='price'] .a-offscreen",
          ".reinventPricePriceToPayMargin .a-offscreen",
          "#apex_offerDisplay_desktop .a-offscreen",
          ".priceToPay .a-offscreen"
        ],
        "fallbackScript": "parseFloat((document.body.innerText.match(/\\$([0-9]{1,4}\\.?[0-9]{0,2})/) || [])[1]) || null",
        "transform": "parseFloat(String(text).replace(/[^0-9.]/g, ''))"
      },
      "saveAs": "currentPrice",
      "validate": {
        "type": "number",
        "range": [1, 10000]
      },
      "retry": {
        "strategies": ["scroll", "wait"],
        "maxAttempts": 3
      },
      "required": true
    },
    {
      "id": "extract-availability",
      "action": "extract",
      "selector": {
        "chain": [
          "#availability span",
          "#availability",
          ".availabilityMessage",
          "#add-to-cart-button"
        ],
        "fallbackScript": "document.body.innerText.includes('In Stock') ? 'In Stock' : document.body.innerText.includes('Add to Cart') ? 'Available' : document.body.innerText.includes('Currently unavailable') ? 'Unavailable' : 'Unknown'"
      },
      "saveAs": "availability",
      "required": false
    },
    {
      "id": "extract-rating",
      "action": "extract",
      "selector": {
        "chain": [
          "#acrPopover .a-size-base",
          ".reviewCountTextLinkedHistogram",
          "[data-hook='rating-out-of-text']"
        ],
        "fallbackScript": "(document.body.innerText.match(/([0-9]\\.[0-9]) out of 5/) || [])[1] || null"
      },
      "saveAs": "rating",
      "validate": {
        "type": "number",
        "range": [1, 5]
      },
      "required": false
    },
    {
      "id": "capture-proof",
      "action": "screenshot",
      "params": { "fullPage": true },
      "saveAs": "proofPdf",
      "required": true
    }
  ],
  "alerts": {
    "slack": {
      "webhook": "${SLACK_WEBHOOK_URL}",
      "channel": "#price-alerts"
    },
    "conditions": {
      "priceBelow": 200,
      "priceChange": true,
      "availabilityChange": true,
      "statusFailed": true
    }
  }
}
