#!/usr/bin/env bash
# ATL - Accessibility-based browser automation for iOS WebKit
# https://github.com/yourusername/atl

set -e

ATL_DIR="$(cd "$(dirname "$0")/.." && pwd)"
ATL_PORT="${ATL_PORT:-9222}"
ATL_SIMULATOR="${ATL_SIMULATOR:-iPhone 17}"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
BOLD='\033[1m'
NC='\033[0m'

log() { echo -e "${BLUE}[atl]${NC} $1"; }
success() { echo -e "${GREEN}[atl]${NC} $1"; }
warn() { echo -e "${YELLOW}[atl]${NC} $1"; }
error() { echo -e "${RED}[atl]${NC} $1"; }

# Check if Xcode CLI tools are installed
check_xcode() {
    if ! command -v xcrun &> /dev/null; then
        error "Xcode command line tools not found."
        echo ""
        echo "Install with:"
        echo "  xcode-select --install"
        echo ""
        echo "Or install Xcode from the App Store."
        exit 1
    fi

    # Check if simulators are available
    if ! xcrun simctl list devices &> /dev/null; then
        error "iOS Simulator runtime not found."
        echo ""
        echo "Install Xcode from the App Store to get Simulator support."
        exit 1
    fi
}

# Find a suitable simulator
find_simulator() {
    local sim_name="$1"

    # Try exact match first
    local udid=$(xcrun simctl list devices available -j | \
        jq -r ".devices[][] | select(.name == \"$sim_name\") | .udid" | \
        head -1)

    if [ -n "$udid" ]; then
        echo "$udid"
        return 0
    fi

    # Try partial match (any iPhone)
    udid=$(xcrun simctl list devices available -j | \
        jq -r ".devices[][] | select(.name | contains(\"iPhone\")) | .udid" | \
        head -1)

    if [ -n "$udid" ]; then
        echo "$udid"
        return 0
    fi

    return 1
}

# Get simulator state
get_sim_state() {
    local udid="$1"
    xcrun simctl list devices -j | jq -r ".devices[][] | select(.udid == \"$udid\") | .state"
}

# Boot simulator if needed
boot_simulator() {
    local udid="$1"
    local state=$(get_sim_state "$udid")

    if [ "$state" = "Booted" ]; then
        log "Simulator already booted"
        return 0
    fi

    log "Booting simulator..."
    xcrun simctl boot "$udid" 2>/dev/null || true

    # Wait for boot
    local attempts=0
    while [ "$(get_sim_state "$udid")" != "Booted" ] && [ $attempts -lt 30 ]; do
        sleep 1
        attempts=$((attempts + 1))
    done

    if [ "$(get_sim_state "$udid")" = "Booted" ]; then
        success "Simulator booted"
        return 0
    else
        error "Failed to boot simulator"
        return 1
    fi
}

# Find AtlBrowser.app
find_app() {
    # Check for pre-built app in bin/
    if [ -d "$ATL_DIR/bin/AtlBrowser.app" ]; then
        echo "$ATL_DIR/bin/AtlBrowser.app"
        return 0
    fi

    # Check DerivedData for recent build
    local derived_app=$(find ~/Library/Developer/Xcode/DerivedData/AtlBrowser-*/Build/Products/Debug-iphonesimulator/AtlBrowser.app -maxdepth 0 2>/dev/null | head -1)
    if [ -d "$derived_app" ]; then
        echo "$derived_app"
        return 0
    fi

    return 1
}

# Build AtlBrowser if needed
build_app() {
    log "Building AtlBrowser..."

    local workspace="$ATL_DIR/AtlBrowser/AtlBrowser.xcworkspace"
    if [ ! -d "$workspace" ]; then
        error "AtlBrowser workspace not found at $workspace"
        exit 1
    fi

    xcodebuild -workspace "$workspace" \
        -scheme AtlBrowser \
        -destination "generic/platform=iOS Simulator" \
        -configuration Debug \
        -quiet \
        build

    find_app
}

# Install app in simulator
install_app() {
    local udid="$1"
    local app_path="$2"

    log "Installing AtlBrowser..."
    xcrun simctl install "$udid" "$app_path"
    success "AtlBrowser installed"
}

# Launch app
launch_app() {
    local udid="$1"

    log "Launching AtlBrowser..."
    xcrun simctl launch "$udid" com.example.AtlBrowser 2>/dev/null || \
    xcrun simctl launch "$udid" com.jordanbietz.AtlBrowser 2>/dev/null || \
    xcrun simctl launch "$udid" $(get_bundle_id) 2>/dev/null

    success "AtlBrowser launched"
}

# Get bundle ID from installed app
get_bundle_id() {
    local app_path=$(find_app)
    if [ -n "$app_path" ]; then
        /usr/libexec/PlistBuddy -c "Print :CFBundleIdentifier" "$app_path/Info.plist" 2>/dev/null
    fi
}

# Wait for server to be ready
wait_for_server() {
    log "Waiting for server on port $ATL_PORT..."

    local attempts=0
    while [ $attempts -lt 30 ]; do
        if curl -s "http://localhost:$ATL_PORT/ping" 2>/dev/null | grep -q "ok"; then
            success "Server ready at http://localhost:$ATL_PORT"
            return 0
        fi
        sleep 1
        attempts=$((attempts + 1))
    done

    error "Server did not start"
    return 1
}

# Check if already running
check_running() {
    if curl -s "http://localhost:$ATL_PORT/ping" 2>/dev/null | grep -q "ok"; then
        return 0
    fi
    return 1
}

# Print status
print_status() {
    echo ""
    echo -e "${BOLD}ATL Browser Automation${NC}"
    echo -e "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo -e "API:        ${GREEN}http://localhost:$ATL_PORT${NC}"
    echo -e "Simulator:  $ATL_SIMULATOR"
    echo ""
    echo "Quick test:"
    echo "  curl http://localhost:$ATL_PORT/ping"
    echo ""
    echo "Navigate:"
    echo "  curl -X POST http://localhost:$ATL_PORT/command \\"
    echo "    -H 'Content-Type: application/json' \\"
    echo "    -d '{\"method\":\"goto\",\"params\":{\"url\":\"https://example.com\"}}'"
    echo ""
}

# Commands
cmd_start() {
    if check_running; then
        success "ATL already running on port $ATL_PORT"
        print_status
        return 0
    fi

    check_xcode

    log "Finding simulator..."
    local udid=$(find_simulator "$ATL_SIMULATOR")
    if [ -z "$udid" ]; then
        error "No simulator found. Available simulators:"
        xcrun simctl list devices available | grep -E "iPhone|iPad" | head -10
        exit 1
    fi

    local sim_name=$(xcrun simctl list devices -j | jq -r ".devices[][] | select(.udid == \"$udid\") | .name")
    log "Using: $sim_name ($udid)"

    boot_simulator "$udid"

    # Open Simulator.app
    open -a Simulator

    # Find or build app
    local app_path=$(find_app)
    if [ -z "$app_path" ]; then
        app_path=$(build_app)
    fi

    if [ -z "$app_path" ] || [ ! -d "$app_path" ]; then
        error "Could not find or build AtlBrowser.app"
        exit 1
    fi

    install_app "$udid" "$app_path"
    launch_app "$udid"
    wait_for_server
    print_status
}

cmd_stop() {
    log "Stopping AtlBrowser..."

    # Find and terminate the app
    local udid=$(find_simulator "$ATL_SIMULATOR")
    if [ -n "$udid" ]; then
        xcrun simctl terminate "$udid" com.example.AtlBrowser 2>/dev/null || true
        xcrun simctl terminate "$udid" com.jordanbietz.AtlBrowser 2>/dev/null || true
    fi

    success "AtlBrowser stopped"
}

cmd_status() {
    if check_running; then
        success "ATL is running"
        print_status
    else
        warn "ATL is not running"
        echo "Start with: atl start"
    fi
}

cmd_help() {
    echo "ATL - Accessibility-based browser automation for iOS WebKit"
    echo ""
    echo "Usage: atl <command>"
    echo ""
    echo "Commands:"
    echo "  start     Start AtlBrowser in simulator"
    echo "  stop      Stop AtlBrowser"
    echo "  status    Check if ATL is running"
    echo "  help      Show this help"
    echo ""
    echo "Environment:"
    echo "  ATL_PORT       API port (default: 9222)"
    echo "  ATL_SIMULATOR  Simulator name (default: iPhone 16)"
    echo ""
    echo -e "${BOLD}Key Feature: PDF Capture${NC}"
    echo "  ATL captures full-page PDFs with vector text + visual layout."
    echo "  Unlike screenshots, PDFs are:"
    echo "    - Searchable and parseable (extract text directly)"
    echo "    - Full page (entire scrollable content, not just viewport)"
    echo "    - Smaller file size for text-heavy pages"
    echo "    - Perfect for Vision + Text hybrid analysis"
    echo ""
    echo "API Endpoints:"
    echo "  GET  /ping                    Health check"
    echo "  POST /command                 Execute command"
    echo ""
    echo "Commands (POST /command):"
    echo ""
    echo "  Navigation:"
    echo "    goto       {url}              Navigate to URL"
    echo "    reload     {}                 Reload page"
    echo "    back       {}                 Go back"
    echo "    forward    {}                 Go forward"
    echo ""
    echo "  Interaction:"
    echo "    click      {selector}         Click element"
    echo "    fill       {selector, value}  Fill input field"
    echo "    type       {text}             Type into focused element"
    echo "    press      {key}              Press key (Enter, Tab, etc.)"
    echo "    hover      {selector}         Hover over element"
    echo ""
    echo "  Capture:"
    echo "    screenshot {}                 PNG of viewport"
    echo "    screenshot {fullPage: true}   PDF of entire page (vector text!)"
    echo "    captureLight {}               Text + interactives only (~99% smaller)"
    echo ""
    echo "  Accessibility (Set-of-Mark):"
    echo "    mark       {}                 Label all interactive elements [0,1,2...]"
    echo "    clickMark  {label: 5}         Click element by label number"
    echo "    unmark     {}                 Remove all labels"
    echo ""
    echo "  Selectors:"
    echo "    querySelector    {selector}   Get element info"
    echo "    querySelectorAll {selector}   Get all matching elements"
    echo "    waitForSelector  {selector}   Wait for element to appear"
    echo ""
    echo "Examples:"
    echo "  atl start"
    echo ""
    echo "  # Health check"
    echo "  curl http://localhost:9222/ping"
    echo ""
    echo "  # Navigate"
    echo "  curl -X POST http://localhost:9222/command \\"
    echo "    -d '{\"method\":\"goto\",\"params\":{\"url\":\"https://amazon.com\"}}'"
    echo ""
    echo "  # Capture full-page PDF (text + vision)"
    echo "  curl -X POST http://localhost:9222/command \\"
    echo "    -d '{\"method\":\"screenshot\",\"params\":{\"fullPage\":true}}' \\"
    echo "    | jq -r '.result.data' | base64 -d > page.pdf"
    echo ""
    echo "  # Mark elements, take screenshot, click by number"
    echo "  curl -X POST http://localhost:9222/command -d '{\"method\":\"mark\"}'"
    echo "  curl -X POST http://localhost:9222/command -d '{\"method\":\"clickMark\",\"params\":{\"label\":3}}'"
}

# Main
case "${1:-}" in
    start)
        cmd_start
        ;;
    stop)
        cmd_stop
        ;;
    status)
        cmd_status
        ;;
    help|--help|-h)
        cmd_help
        ;;
    *)
        cmd_help
        exit 1
        ;;
esac
